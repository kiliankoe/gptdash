<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPTDash - Host Control Panel</title>
    <!-- TODO: Add HTTP Basic Auth protection for this page -->
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/host.css">
    <script src="/js/qrcode.min.js"></script>
</head>


<body>
    <!-- Header -->
    <div class="header">
        <h1>GPTDash Host-Kontrollzentrum</h1>
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Nicht verbunden</span>
            </div>
            <div class="status-item">
                <span id="phaseDisplay">Phase: LOBBY</span>
            </div>
            <div class="status-item">
                <span id="roundDisplay">Runde: 0</span>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-item active" onclick="showPanel('overview')">Übersicht</div>
            <div class="sidebar-item" onclick="showPanel('game')">Spiel-Steuerung</div>
            <div class="sidebar-item" onclick="showPanel('players')">Spieler</div>
            <div class="sidebar-item" onclick="showPanel('prompts')">Prompts</div>
            <div class="sidebar-item" onclick="showPanel('submissions')">Antworten</div>
            <div class="sidebar-item" onclick="showPanel('scores')">Punkte</div>
            <div class="sidebar-item" onclick="showPanel('state')">State-Export</div>
            <div class="sidebar-item" onclick="showPanel('logs')">Nachrichten-Log</div>
        </div>

        <!-- Main Content -->
        <div class="main">
            <!-- Overview Panel -->
            <div class="panel active" id="overview">
                <h2>Übersicht</h2>

                <div class="card">
                    <div class="card-header">Spiel-Status</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="label">Aktuelle Phase</div>
                            <div class="value" id="overviewPhase">LOBBY</div>
                        </div>
                        <div class="info-item">
                            <div class="label">Runden-Nummer</div>
                            <div class="value" id="overviewRound">0</div>
                        </div>
                        <div class="info-item">
                            <div class="label">Spieler</div>
                            <div class="value" id="overviewPlayers">0</div>
                        </div>
                        <div class="info-item">
                            <div class="label">Antworten</div>
                            <div class="value" id="overviewSubmissions">0</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Schnellzugriff</div>
                    <div class="button-group">
                        <button onclick="hostCreatePlayers(3)">3 Spieler erstellen</button>
                        <button onclick="hostStartRound()">Runde starten</button>
                        <button onclick="transitionPhase('WRITING')">→ Schreiben</button>
                        <button onclick="transitionPhase('VOTING')">→ Abstimmen</button>
                        <button onclick="transitionPhase('RESULTS')">→ Auflösung</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Publikum beitreten lassen</div>
                    <div style="text-align: center; padding: 20px;">
                        <div id="audienceQRCode" style="display: inline-block; margin-bottom: 15px;"></div>
                        <div style="font-size: 18px; font-weight: bold;" id="audienceJoinUrl">Laden...</div>
                        <button onclick="copyAudienceUrl()" style="margin-top: 10px;">URL kopieren</button>
                    </div>
                </div>

                <div id="overviewAlert"></div>
            </div>

            <!-- Game Control Panel -->
            <div class="panel" id="game">
                <h2>Spiel-Steuerung</h2>

                <div class="card">
                    <div class="card-header">Phasen-Übergänge</div>
                    <div class="phase-selector" id="phaseButtons">
                        <button data-phase="LOBBY" onclick="transitionPhase('LOBBY')">Lobby</button>
                        <button data-phase="WRITING" onclick="transitionPhase('WRITING')">Schreiben</button>
                        <button data-phase="REVEAL" onclick="transitionPhase('REVEAL')">Antworten zeigen</button>
                        <button data-phase="VOTING" onclick="transitionPhase('VOTING')">Abstimmen</button>
                        <button data-phase="RESULTS" onclick="transitionPhase('RESULTS')">Auflösung</button>
                        <button data-phase="PODIUM" onclick="transitionPhase('PODIUM')">Siegerehrung</button>
                        <button data-phase="INTERMISSION" onclick="transitionPhase('INTERMISSION')">Pause</button>
                        <button data-phase="ENDED" onclick="transitionPhase('ENDED')" class="danger">Spiel beenden</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Aktuelle Runde</div>
                    <div id="currentRoundInfo" style="margin-bottom: 10px;">
                        <p style="opacity: 0.6;">Keine aktive Runde. Wähle einen Prompt aus dem "Prompts"-Panel aus, um eine neue Runde zu starten.</p>
                    </div>
                    <div class="button-group">
                        <button onclick="closeWriting()">Schreib-Phase beenden</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Timer</div>
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <span>Verbleibend: <strong id="hostTimer" style="font-size: 1.5em; font-family: monospace;">--:--</strong></span>
                        <button onclick="extendTimer(10)" class="secondary">+10 Sekunden</button>
                    </div>
                    <p style="opacity: 0.6; font-size: 0.9em;">Timer für Schreib- und Abstimmungsphase. Der Abstimmungstimer wechselt automatisch zur Auflösung.</p>
                </div>

                <div class="card">
                    <div class="card-header">Notfall-Steuerung</div>
                    <div class="button-group">
                        <button class="secondary" onclick="transitionPhase('INTERMISSION')">Pause</button>
                        <button class="danger" onclick="resetGame()">Spiel zurücksetzen</button>
                    </div>
                    <div class="button-group" style="margin-top: 10px;">
                        <button class="secondary" onclick="clearPromptPool()">Prompt-Pool leeren</button>
                    </div>
                    <p style="opacity: 0.6; font-size: 0.9em; margin-top: 8px;">"Spiel zurücksetzen" behält Prompts. "Prompt-Pool leeren" löscht alle unselektierten Prompts.</p>
                </div>

                <div class="card" style="border: 2px solid #ff4444;">
                    <div class="card-header" style="color: #ff4444;">PANIK-MODUS</div>
                    <p style="opacity: 0.8; margin-bottom: 10px;">
                        Deaktiviert alle Publikums-Abstimmungen. Das Publikum stimmt dann analog ab (z.B. durch Klatschen),
                        und du wählst die Gewinner manuell aus.
                    </p>
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <span>Status: <strong id="panicStatus">Inaktiv</strong></span>
                    </div>
                    <button id="panicModeBtn" class="danger" onclick="togglePanicMode()">PANIK-MODUS aktivieren</button>

                    <div id="manualWinnerSection" style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <h4 style="margin-bottom: 10px;">Manuelle Gewinner-Auswahl</h4>
                        <p style="opacity: 0.8; margin-bottom: 10px;">Wähle die Gewinner basierend auf dem Applaus des Publikums.</p>
                        <div id="manualWinnerButtons">
                            <!-- Will be populated with submission buttons when submissions exist -->
                            <p style="opacity: 0.6;">Antworten werden hier angezeigt, sobald verfügbar.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Players Panel -->
            <div class="panel" id="players">
                <h2>Spieler-Verwaltung</h2>

                <div class="card">
                    <div class="card-header">Spieler erstellen</div>
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                        <input type="number" id="playerCount" value="3" min="1" max="10"
                            style="max-width: 100px; margin-bottom: 0;">
                        <button onclick="hostCreatePlayersCustom()">Spieler erstellen</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Spieler-Tokens</div>
                    <div id="playerTokensList">
                        <p style="opacity: 0.6;">Noch keine Spieler erstellt</p>
                    </div>
                </div>
            </div>

            <!-- Prompts Panel -->
            <div class="panel" id="prompts">
                <h2>Prompt-Verwaltung</h2>

                <div class="card">
                    <div class="card-header">Prompt hinzufügen</div>
                    <textarea id="promptText" placeholder="Gib hier deinen Prompt ein..."></textarea>
                    <details style="margin: 10px 0;">
                        <summary style="cursor: pointer; opacity: 0.8;">Bild hinzufügen (Multimodal)</summary>
                        <div style="margin-top: 10px;">
                            <p style="opacity: 0.7; font-size: 0.9em; margin-bottom: 10px;">
                                Füge eine Bild-URL hinzu für eine multimodale Runde. Das Bild wird auf Beamer und Player-Geräten angezeigt.
                            </p>
                            <input type="url" id="promptImageUrl" placeholder="https://example.com/image.png" style="width: 100%; margin-bottom: 10px;">
                            <div id="promptImagePreview" style="margin-bottom: 10px; text-align: center;"></div>
                        </div>
                    </details>
                    <button onclick="addPrompt()">Prompt hinzufügen</button>
                </div>

                <div class="card" style="border: 2px solid #51cf66;">
                    <div class="card-header" style="color: #51cf66;">Warteschlange für nächste Runde (max. 3)</div>
                    <div id="queuedPromptsList">
                        <p style="opacity: 0.6;">Keine Prompts in der Warteschlange. Wähle Prompts aus dem Pool.</p>
                    </div>
                    <button id="startPromptSelectionBtn" onclick="startPromptSelection()" style="display: none; margin-top: 15px; background: #51cf66;" class="primary">▶ Runde starten</button>
                </div>

                <div class="card">
                    <div class="card-header">Prompt-Pool</div>
                    <div id="promptsList">
                        <p style="opacity: 0.6;">Keine Prompts verfügbar</p>
                    </div>
                </div>
            </div>

            <!-- Submissions Panel -->
            <div class="panel" id="submissions">
                <h2>Antworten</h2>

                <div class="card" style="border: 2px solid #4dabf7;">
                    <div class="card-header" style="color: #4dabf7;">KI-Antwort Verwaltung</div>
                    <div id="aiGenerationStatus" style="margin-bottom: 15px;">
                        <p style="opacity: 0.6;">KI-Status: Warte auf Prompt-Auswahl</p>
                    </div>

                    <div id="aiSubmissionsList" style="margin-bottom: 15px;">
                        <!-- AI submissions will be listed here for selection -->
                    </div>

                    <div class="button-group" style="margin-bottom: 15px;">
                        <button onclick="regenerateAi()" class="secondary">KI neu generieren</button>
                    </div>

                    <details style="margin-top: 10px;">
                        <summary style="cursor: pointer; opacity: 0.8;">Manuelle KI-Antwort (Notfall-Override)</summary>
                        <div style="margin-top: 10px;">
                            <p style="opacity: 0.7; font-size: 0.9em; margin-bottom: 10px;">
                                Falls die automatische KI-Generierung fehlschlägt, kannst du hier manuell eine KI-Antwort eingeben.
                            </p>
                            <textarea id="manualAiText" placeholder="Manuelle KI-Antwort eingeben..." style="margin-bottom: 10px;"></textarea>
                            <button onclick="writeManualAiSubmission()">Als KI-Antwort speichern</button>
                        </div>
                    </details>
                </div>

                <div class="card">
                    <div class="card-header">Antworten-Reihenfolge</div>
                    <div class="reorder-hint">
                        <span class="icon">↕️</span>
                        <span>Ziehe die Antworten per Drag &amp; Drop in die gewünschte Reihenfolge</span>
                    </div>
                    <div id="submissionsList" class="submissions-list">
                        <p style="opacity: 0.6;">Noch keine Antworten</p>
                    </div>

                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; opacity: 0.7; font-size: 13px;">Manuelle ID-Eingabe (Fallback)</summary>
                        <div style="margin-top: 10px;">
                            <textarea id="revealOrderInput" placeholder="sub_123, sub_456, sub_789" style="margin-bottom: 10px;"></textarea>
                            <button onclick="setRevealOrder()" class="secondary">Reihenfolge festlegen</button>
                        </div>
                    </details>
                </div>

                <div class="card">
                    <div class="card-header">Antworten-Navigation</div>
                    <p style="opacity: 0.8; margin-bottom: 10px;">Steuere das Anzeigen der Antworten während der REVEAL-Phase.</p>
                    <div class="button-group">
                        <button onclick="revealPrev()" class="secondary">← Zurück</button>
                        <button onclick="revealNext()">Weiter →</button>
                    </div>
                </div>
            </div>

            <!-- Scores Panel -->
            <div class="panel" id="scores">
                <h2>Punkte & Bestenlisten</h2>

                <div class="card">
                    <div class="card-header">Spieler-Punkte</div>
                    <div id="playerScores">
                        <p style="opacity: 0.6;">Noch keine Punkte</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Top Publikum</div>
                    <div id="audienceScores">
                        <p style="opacity: 0.6;">Noch keine Publikums-Punkte</p>
                    </div>
                </div>
            </div>

            <!-- State Export/Import Panel -->
            <div class="panel" id="state">
                <h2>State-Verwaltung</h2>

                <div class="card">
                    <div class="card-header">Export</div>
                    <p style="opacity: 0.8; margin-bottom: 15px;">
                        Exportiere den kompletten Spielzustand als JSON-Datei für Backup oder Debugging.
                    </p>
                    <div class="button-group">
                        <button onclick="refreshStateView()">Aktualisieren</button>
                        <button onclick="downloadStateExport()">Als Datei herunterladen</button>
                        <button onclick="copyStateToClipboard()" class="secondary">In Zwischenablage</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Aktueller Zustand</div>
                    <div style="position: relative;">
                        <pre id="stateJsonView" class="state-json-view">Klicke "Aktualisieren" um den Zustand zu laden...</pre>
                    </div>
                </div>

                <div class="card" style="border: 2px solid #ff9800;">
                    <div class="card-header" style="color: #ff9800;">⚠️ Import (Vorsicht!)</div>
                    <p style="opacity: 0.8; margin-bottom: 15px;">
                        <strong>Warnung:</strong> Der Import ersetzt den gesamten Spielzustand!
                        Alle verbundenen Clients werden über den neuen Zustand informiert.
                    </p>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">JSON-Datei hochladen:</label>
                        <input type="file" id="stateImportFile" accept=".json" onchange="handleStateFileSelect(event)" style="margin-bottom: 10px;">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">Oder JSON einfügen:</label>
                        <textarea id="stateImportText" placeholder='{"schema_version": 1, ...}' style="height: 150px; font-family: monospace; font-size: 12px;"></textarea>
                    </div>

                    <div class="button-group">
                        <button onclick="validateStateImport()" class="secondary">Validieren</button>
                        <button onclick="executeStateImport()" class="danger">Importieren</button>
                    </div>
                    <div id="stateImportStatus" style="margin-top: 10px;"></div>
                </div>
            </div>

            <!-- Logs Panel -->
            <div class="panel" id="logs">
                <h2>Nachrichten-Log</h2>

                <div class="card">
                    <button onclick="clearLog()" class="secondary">Log leeren</button>
                    <div id="messageLog" class="log" style="margin-top: 15px;">
                        <!-- Log entries will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="/js/common.js"></script>
    <script src="/js/host.js"></script>
</body>

</html>
